<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>JSON → Dart (Freezed) Generator (Safe fromJson)</title>
  <style>
    :root { --bg:#f8fafc; --card:#fff; --fg:#0f172a; --muted:#64748b; --border:#e2e8f0; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial}
    h1{font-weight:600;letter-spacing:.2px}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .btn{border:1px solid var(--fg);background:var(--fg);color:#fff;border-radius:14px;padding:8px 14px;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--fg);border:1px solid var(--border)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:768px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    textarea{width:100%;min-height:420px;border:1px solid var(--border);border-radius:12px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;font-size:13px}
    input[type=text],select{border:1px solid var(--border);border-radius:10px;padding:6px 10px;font-size:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:12px}
    pre{background:#0b1220;color:#e6edf3;border-radius:12px;border:1px solid #0b1220;padding:12px;min-height:420px;overflow:auto;font-size:12px;line-height:1.5;white-space:pre}
    .err{color:#b91c1c;font-size:13px;margin-top:8px}
    .list{color:#a16207;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <h1>JSON → Dart (Freezed) Generator</h1>
      <div class="row">
        <button id="copyBtn" class="btn">Copy</button>
        <button id="downloadBtn" class="btn secondary">Download .dart</button>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <div class="row" style="justify-content:space-between;margin-bottom:8px">
          <label><strong>Input JSON</strong></label>
          <div class="row">
            <span class="muted">Nullability</span>
            <select id="mode">
              <option value="all_nullable">All nullable (?)</option>
              <option value="smart">Smart (infer)</option>
            </select>
            <label class="row"><input id="includeJson" type="checkbox" checked style="margin-right:6px">include fromJson/toJson</label>
          </div>
        </div>
        <textarea id="json"></textarea>
        <div id="error" class="err" style="display:none"></div>
        <ul id="warnings" class="list"></ul>
      </section>

      <section class="card">
        <div class="row" style="justify-content:space-between;margin-bottom:8px">
          <div class="row">
            <label for="root"><strong>Root class</strong></label>
            <input type="text" id="root" style="margin-left:8px;width:200px">
          </div>
          <div class="muted">Adds <code>@JsonKey(fromJson: ...)</code> to every field • Freezed + json_serializable</div>
        </div>
        <pre id="code"></pre>
      </section>
    </div>

    <p class="muted" style="margin-top:16px">After saving, run <code>flutter pub run build_runner build --delete-conflicting-outputs</code>.</p>
  </div>

<script>
// ===== Utilities =====
var RESERVED_DART_WORDS = new Set([
  "abstract","else","import","super","as","enum","in","switch","assert","export","interface","sync","async","extends","is","this","await","extension","library","throw","break","external","mixin","true","case","factory","new","try","catch","false","null","typedef","class","final","on","var","const","finally","operator","void","continue","for","part","while","covariant","Function","rethrow","with","default","get","return","yield","deferred","hide","set","do","if","show","dynamic","implements","static"
]);
var ISO_DATE_RE = /^(\d{4}-\d{2}-\d{2})([Tt ]\d{2}:\d{2}:\d{2}(?:\.\d+)?(?:Z|[+-]\d{2}:?\d{2})?)?$/;

function toPascalCase(input){
  var cleaned = String(input)
    .replace(/[^A-Za-z0-9]+/g," ")
    .replace(/([a-z0-9])([A-Z])/g,"$1 $2")
    .trim();
  if(!cleaned) return "ClassName";
  return cleaned.split(/\s+/).map(function(s){return s.charAt(0).toUpperCase()+s.slice(1).toLowerCase()}).join("")
    .replace(/^[0-9]+/, function(m){return "N"+m});
}
function toCamelCase(input){ var pas = toPascalCase(input); return pas.charAt(0).toLowerCase()+pas.slice(1); }
function toSnakeCase(input){
  return String(input)
    .replace(/([a-z0-9])([A-Z])/g,"$1_$2")
    .replace(/[^A-Za-z0-9]+/g,"_")
    .replace(/__+/g,"_")
    .replace(/^_+|_+$/g,"")
    .toLowerCase();
}
function sanitizeFieldName(name){
  var n = toCamelCase(name);
  if(/^[0-9]/.test(n)) n = "v"+n;
  if(RESERVED_DART_WORDS.has(n)) n = n+"Value";
  if(!n) n = "field";
  return n;
}
function sanitizeBaseClassName(name){
  var n = toPascalCase(name);
  if(RESERVED_DART_WORDS.has(n)) n = n+"Type";
  if(!n) n = "Model";
  return n;
}
function singularize(name){
  if(/ies$/i.test(name)) return name.replace(/ies$/i,"y");
  if(/ses$/i.test(name)) return name.replace(/es$/i,"");
  if(/s$/i.test(name) && !/ss$/i.test(name)) return name.replace(/s$/i,"");
  return name;
}
function detectDateTime(s){ return ISO_DATE_RE.test(s); }
function analyzeNumberType(values){ for(var i=0;i<values.length;i++){ if(Math.floor(values[i])!==values[i]) return "double"; } return "int"; }
function isPlainObject(x){ return x!==null && typeof x==="object" && !Array.isArray(x); }
function makeUniqueName(base, used){
  var name = base; var i=1;
  while(used.has(name)){ name = base + i; i++; }
  used.add(name);
  return name;
}

// ===== Generator with safe fromJson converters for ALL fields =====
function generateClassesFromJson(jsonValue, rootNameRaw, opts){
  var classes = new Map();
  var warnings = [];
  var usedClassNames = new Set();

  // Track which helper functions we need to emit
  var helperNames = new Set();
  var helperCode = [];

  function addHelper(name, code){
    if(!helperNames.has(name)){
      helperNames.add(name);
      helperCode.push(code);
    }
    return name;
  }

  function uniqueClassName(base){
    var safeBase = sanitizeBaseClassName(base);
    return makeUniqueName(safeBase, usedClassNames);
  }
  function ensureClass(name){
    if(!classes.has(name)) classes.set(name, { name: name, fields: [] });
    return classes.get(name);
  }

  function inferTypeForArray(arr, keyHint, ownerClass){
    if(arr.length===0) return { dart: "List<dynamic>" };
    var nonNulls = arr.filter(function(v){ return v!==null && v!==undefined; });
    if(nonNulls.length===0) return { dart: "List<dynamic>" };

    if(nonNulls.every(isPlainObject)){
      var childName = uniqueClassName(toPascalCase(singularize(keyHint)) || (ownerClass+"Item"));
      var child = ensureClass(childName);
      var usedFieldNames = new Set();
      var unionKeys = new Set();
      for(var i=0;i<nonNulls.length;i++){ var o = nonNulls[i]; Object.keys(o).forEach(function(k){ unionKeys.add(k); }); }
      unionKeys.forEach(function(k){
        var rep;
        for(var i=0;i<nonNulls.length;i++){ if(k in nonNulls[i]){ rep = nonNulls[i][k]; break; } }
        child.fields.push(inferFieldSpec(k, rep, childName, usedFieldNames));
      });
      return { dart: "List<"+childName+">", nestedClass: childName };
    }
    if(nonNulls.every(function(v){return typeof v==="string"})){
      var maybeDate = nonNulls.every(function(s){ return typeof s==="string" && detectDateTime(s); });
      return { dart: maybeDate ? "List<DateTime>" : "List<String>" };
    }
    if(nonNulls.every(function(v){return typeof v==="number"})){
      var kind = analyzeNumberType(nonNulls);
      return { dart: "List<"+kind+">" };
    }
    if(nonNulls.every(function(v){return typeof v==="boolean"})) return { dart: "List<bool>" };
    return { dart: "List<dynamic>" };
  }

  function inferFieldSpec(originalKey, value, ownerClassName, usedFieldNames){
    var baseName = sanitizeFieldName(originalKey);
    var uniqueFieldName = makeUniqueName(baseName, usedFieldNames);

    var dartType = "dynamic";
    var nullable = true;
    if(!opts.allNullable){ nullable = (value===null || value===undefined); }

    if(value===null || value===undefined){
      dartType = "dynamic";
    } else if(Array.isArray(value)){
      var arrInfo = inferTypeForArray(value, originalKey, ownerClassName);
      dartType = arrInfo.dart;
    } else if(isPlainObject(value)){
      var childName = uniqueClassName(toPascalCase(originalKey) || (ownerClassName+"Child"));
      var child = ensureClass(childName);
      var usedChildFields = new Set();
      Object.keys(value).forEach(function(k){
        child.fields.push(inferFieldSpec(k, value[k], childName, usedChildFields));
      });
      dartType = childName;
    } else {
      switch(typeof value){
        case "string": dartType = detectDateTime(value) ? "DateTime" : "String"; break;
        case "number": dartType = (Math.floor(value)===value) ? "int" : "double"; break;
        case "boolean": dartType = "bool"; break;
        default: dartType = "dynamic";
      }
    }
    if(opts.allNullable) nullable = true;
    return { nameOriginal: originalKey, nameDart: uniqueFieldName, dartType: dartType, nullable: nullable };
  }

  function processRoot(value, rootName){
    var root = ensureClass(rootName);
    var used = new Set();
    if(Array.isArray(value)){
      warnings.push("Top-level JSON is an array; generated a wrapper model with a single list field.");
      var info = inferTypeForArray(value, singularize(rootName), rootName);
      root.fields.push({
        nameOriginal: toCamelCase(singularize(rootName)),
        nameDart: makeUniqueName(toCamelCase(singularize(rootName)), used),
        dartType: info.dart,
        nullable: true
      });
    } else if(isPlainObject(value)){
      Object.keys(value).forEach(function(k){
        root.fields.push(inferFieldSpec(k, value[k], rootName, used));
      });
    } else {
      warnings.push("Top-level JSON is a primitive; wrapping as a single dynamic field.");
      root.fields.push({ nameOriginal: "value", nameDart: makeUniqueName("value", used), dartType: "dynamic", nullable: true });
    }
  }

  // Helper name resolver: returns the function name to use and records helper code
  function helperForType(dartType){
    // Primitives
    if(dartType==="String"){
      return addHelper("_toStringOrNull",
`String? _toStringOrNull(Object? input) {
  return input is String ? input : null;
}`);
    }
    if(dartType==="bool"){
      return addHelper("_toBoolOrNull",
`bool? _toBoolOrNull(Object? input) {
  return input is bool ? input : null;
}`);
    }
    if(dartType==="int"){
      return addHelper("_toIntOrNull",
`int? _toIntOrNull(Object? input) {
  if (input is int) return input;
  return null;
}`);
    }
    if(dartType==="double"){
      return addHelper("_toDoubleOrNull",
`double? _toDoubleOrNull(Object? input) {
  if (input is num) return input.toDouble();
  return null;
}`);
    }
    if(dartType==="DateTime"){
      return addHelper("_toDateTimeOrNull",
`DateTime? _toDateTimeOrNull(Object? input) {
  if (input is String) {
    try { return DateTime.parse(input); } catch (_) { return null; }
  }
  return null;
}`);
    }

    // Lists
    var m = /^List<(.+)>$/.exec(dartType);
    if(m){
      var inner = m[1];
      if (!/^(String|bool|int|double|DateTime)$/.test(inner)) {
        // ensure child helper exists
        helperForType(inner);
        var listHelperName = "_toListOf"+inner+"OrNull";
        return addHelper(listHelperName,
`List<${inner}>? ${listHelperName}(Object? input) {
  if (input is List) {
    final out = <${inner}>[];
    for (final e in input) {
      final v = _to${inner}OrNull(e);
      if (v == null) return null;
      out.add(v);
    }
    return out;
  }
  return null;
}`);
      } else {
        var innerHelper = helperForType(inner);
        var listHelper = "_toListOf"+inner+"OrNull";
        return addHelper(listHelper,
`List<${inner}>? ${listHelper}(Object? input) {
  if (input is List) {
    final out = <${inner}>[];
    for (final e in input) {
      final v = ${innerHelper}(e);
      if (v == null) return null;
      out.add(v);
    }
    return out;
  }
  return null;
}`);
      }
    }

    // Nested object
    var className = dartType;
    var helperName = "_to"+className+"OrNull";
    return addHelper(helperName,
`${className}? ${helperName}(Object? input) {
  if (input is Map<String, Object?>) return ${className}.fromJson(input);
  if (input is Map<String, dynamic>) return ${className}.fromJson(input.map((k, v) => MapEntry(k as String, v)));
  return null;
}`);
  }

  var rootName = uniqueClassName(rootNameRaw);
  processRoot(jsonValue, rootName);

  var fileBase = toSnakeCase(rootName);
  var header = "// Generated by JSON → Dart (Freezed) Generator\n"
    + "// ignore_for_file: invalid_annotation_target\n"
    + "import 'package:freezed_annotation/freezed_annotation.dart';\n\n"
    + "part '"+fileBase+".freezed.dart';\n"
    + "part '"+fileBase+".g.dart';\n";

  var blocks = [];
  classes.forEach(function(cls){
    var params = cls.fields.map(function(f){
      var fromJsonFn = helperForType(f.dartType);
      return "    @JsonKey(name: '"+f.nameOriginal+"', fromJson: "+fromJsonFn+") "+f.dartType+(f.nullable ? "?" : "")+" "+f.nameDart+",";
    }).join("\n");
    var ctor = "  const factory "+cls.name+"({\n"+params+"\n  }) = _"+cls.name+";";
    var jsonFactory = opts.includeFromToJson ? ("\n\n  factory "+cls.name+".fromJson(Map<String, Object?> json) => _$"+cls.name+"FromJson(json);") : "";
    var block = "@freezed\nabstract class "+cls.name+" with _$"+cls.name+" {\n"+ctor+jsonFactory+"\n}";
    blocks.push(block);
  });

  var helpersJoined = "";
  if (helperCode.length){
    helpersJoined = "\n\n// ---- Safe fromJson helpers (auto-generated) ----\n" + helperCode.join("\n\n");
  }

  return { code: [header].concat(blocks).join("\n\n") + helpersJoined, warnings: warnings };
}

// ===== Page logic =====
var jsonTA = document.getElementById("json");
var rootInput = document.getElementById("root");
var modeSel = document.getElementById("mode");
var includeJson = document.getElementById("includeJson");
var codePre = document.getElementById("code");
var warnUl = document.getElementById("warnings");
var errDiv = document.getElementById("error");

jsonTA.value = JSON.stringify({
  id: 123,
  name: "Jane Doe",
  email_address: "jane@example.com",
  is_active: true,
  score: 9.75,
  created_at: "2024-12-31T10:15:30Z",
  tags: ["pro","vip"],
  preferences: { theme: "dark", notifications: { email: true, sms: null } },
  friends: [{ id:1, name:"Alice" }, { id:2, name:"Bob" }],
  is_sms: ""
}, null, 2);

rootInput.value = "UserModel";
modeSel.value = "all_nullable";
includeJson.checked = true;

function render(){
  errDiv.style.display = "none";
  errDiv.textContent = "";
  warnUl.innerHTML = "";

  var opts = { allNullable: modeSel.value==="all_nullable", abstractClass: true, includeFromToJson: includeJson.checked };
  try {
    var data = JSON.parse(jsonTA.value);
    var result = generateClassesFromJson(data, sanitizeBaseClassName(rootInput.value || "Model"), opts);
    codePre.textContent = result.code;
    result.warnings.forEach(function(w){
      var li = document.createElement("li"); li.textContent = w; warnUl.appendChild(li);
    });
  } catch (e){
    codePre.textContent = "";
    errDiv.textContent = e && e.message ? e.message : String(e);
    errDiv.style.display = "block";
  }
}
jsonTA.addEventListener("input", render);
rootInput.addEventListener("input", render);
modeSel.addEventListener("change", render);
includeJson.addEventListener("change", render);
window.addEventListener("load", render);

document.getElementById("copyBtn").addEventListener("click", function(){
  var t = codePre.textContent;
  navigator.clipboard.writeText(t).catch(function(){
    var ta = document.createElement("textarea"); ta.value = t; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
  });
});
document.getElementById("downloadBtn").addEventListener("click", function(){
  var base = toSnakeCase(rootInput.value || "model");
  var blob = new Blob([codePre.textContent], {type:"text/plain;charset=utf-8"});
  var url = URL.createObjectURL(blob);
  var a = document.createElement("a"); a.href = url; a.download = base + ".dart"; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
});
</script>
</body>
</html>
